name: Daily AIQuant Analysis

on:
  workflow_dispatch:  # Allows manual triggering
  schedule:
    - cron: '0 9 * * 1-5'  # Runs at 09:00 UTC (17:00 Beijing Time) on weekdays

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # Install additional system dependencies if needed for plotting libraries
        # sudo apt-get install -y ...

    - name: Run Full Cycle Analysis
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        python service/Unified_Service/run_full_cycle.py

    # ----------------------------------------------------
    # 修复点：将 v3 修改为 v4
    # ----------------------------------------------------
    - name: Upload Report Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: daily-reports
        path: share_reports/
        retention-days: 5

    # (可选) 如果你的 send-mail 步骤前也有用到 download-artifact，也要一并改成 v4
    # 但通常在这个脚本里，发邮件是直接读取当前目录的，可能不需要 download 步骤。
    # 如果后面有 uses: actions/download-artifact@v3，请也改为 @v4

    - name: Zip Reports
      if: success()
      run: |
        cd share_reports
        zip -r ../analysis_reports.zip ./*

    - name: Send Email with Reports
      uses: dawidd6/action-send-mail@v3
      if: success()
      with:
        # You need to set these secrets in your GitHub Repository Settings -> Secrets and variables -> Actions
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: Daily AIQuant Analysis Report - ${{ github.run_id }}
        body: |
          The daily analysis cycle has completed successfully.
          Please find the attached reports.
          
          Run ID: ${{ github.run_id }}
        to: ${{ secrets.MAIL_TO }}
        from: AIQuant Bot
        secure: true
        attachments: analysis_reports.zip
