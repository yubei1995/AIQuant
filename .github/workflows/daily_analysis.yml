name: Daily AIQuant Analysis

on:
  workflow_dispatch:  # Allows manual triggering
  schedule:
    - cron: '0 9 * * 1-5'  # Runs at 09:00 UTC (17:00 Beijing Time) on weekdays

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        # Install Chinese fonts to allow matplotlib to render Chinese characters properly
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei

        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Create Output Directories
      run: |
        mkdir -p service/Block_Analyse/output
        mkdir -p service/LHB_Analyse/output
        mkdir -p service/Daily_Monitor/output
        mkdir -p service/30min_Analyse/output
        mkdir -p service/5min_Analyse/output

    - name: Run Full Cycle Analysis
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        python service/Unified_Service/run_full_cycle.py

    - name: Commit and Push History
      run: |
        git config --global user.name 'AIQuant Bot'
        git config --global user.email 'aiquant-bot@users.noreply.github.com'
        
        # Pull latest changes to avoid conflicts
        git pull --rebase
        
        # Force add ignored history files so the Bot can save them, 
        # but they remain ignored for your local environment.
        git add -f service/LHB_Analyse/output/lhb_analysis_history.csv
        git add -f service/LHB_Analyse/output/lhb_alias_history.csv
        git add -f data/lhb_config.xml
        
        # Check if there are changes and commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update LHB analysis history [skip ci]"
          git push
        fi

    # ----------------------------------------------------
    # 修复点：将 v3 修改为 v4
    # ----------------------------------------------------
    - name: Upload Report Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: daily-reports
        path: share_reports/
        retention-days: 5

    - name: Zip Reports
      if: success()
      run: |
        cd share_reports
        # Remove JS files to prevent Gmail blocking (Security policy blocks zip containing .js)
        rm -f *.js
        zip -r ../analysis_reports.zip ./*

    - name: Send Email with Reports
      uses: dawidd6/action-send-mail@v3
      if: success()
      with:
        # You need to set these secrets in your GitHub Repository Settings -> Secrets and variables -> Actions
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: Daily AIQuant Analysis Report - ${{ github.run_id }}
        body: |
          The daily analysis cycle has completed successfully.
          Please find the attached reports.
          
          Run ID: ${{ github.run_id }}
        to: ${{ secrets.MAIL_TO }}
        from: AIQuant Bot
        secure: true
        attachments: analysis_reports.zip
